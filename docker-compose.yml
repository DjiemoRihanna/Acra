services:
  postgres:
    image: postgres:14-alpine
    container_name: acra-postgres
    network_mode: "host"
    environment:
      POSTGRES_DB: acra
      POSTGRES_USER: acra_admin
      POSTGRES_PASSWORD: changeme123
    volumes:
      - ./data/pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U acra_admin -d acra"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: acra-redis
    network_mode: "host"

  zeek:
    build:
      context: .
      dockerfile: docker/Dockerfile.zeek
    container_name: acra-zeek
    network_mode: "host"
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./data/zeek_logs:/usr/local/zeek/logs
    # Le script est déjà exécutable grâce au Dockerfile
    command: ["/bin/sh", "/zeek_entrypoint.sh"]

  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: acra-web
    network_mode: "host"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - .:/app
      - ./data/zeek_logs:/app/data/zeek_logs:ro
      - ./backups/audit_logs:/app/exports
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://acra_admin:changeme123@localhost:5432/acra
      - REDIS_URL=redis://localhost:6379/0
      - PYTHONUNBUFFERED=1 
      - PYTHONWARNINGS=ignore::DeprecationWarning

  zeek-streamer:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: acra-streamer
    network_mode: "host"
    command: python -u src/ingestion/zeek_stream.py
    depends_on:
      postgres:
        condition: service_healthy
      zeek:
        condition: service_started
    volumes:
      - .:/app
      - ./data/zeek_logs:/app/data/zeek_logs
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://acra_admin:changeme123@localhost:5432/acra
      - REDIS_URL=redis://localhost:6379/0
      - PYTHONUNBUFFERED=1
    restart: always
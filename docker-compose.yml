services:
  postgres:
    image: postgres:14-alpine
    container_name: acra-postgres
    environment:
      POSTGRES_DB: acra
      POSTGRES_USER: acra_admin
      POSTGRES_PASSWORD: changeme123
    volumes:
      - ./data/pgdata:/var/lib/postgresql/data
    # Force Docker à vérifier que la DB accepte réellement les connexions
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U acra_admin -d acra"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: acra-redis
    ports:
      - "6379:6379"

  zeek:
    build:
      context: .
      dockerfile: docker/Dockerfile.zeek
    container_name: acra-zeek
    command: ["zeek", "-i", "eth0", "-C", "local", "LogAscii::use_json=T"]
    network_mode: "host" 
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./data/zeek_logs:/usr/local/zeek/logs

  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: acra-web
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "5000:5000"
    volumes:
      - .:/app
      - ./data/zeek_logs:/app/data/zeek_logs:ro
      - ./backups/audit_logs:/app/exports
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://acra_admin:changeme123@postgres:5432/acra
      - REDIS_URL=redis://acra-redis:6379/0
      - PYTHONUNBUFFERED=1 
      - PYTHONWARNINGS=ignore::DeprecationWarning

  zeek-streamer:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: acra-streamer
    # Utilisation de python -u pour forcer l'affichage des logs en temps réel sans buffer
    command: python -u src/ingestion/zeek_stream.py
    depends_on:
      postgres:
        condition: service_healthy
      zeek:
        condition: service_started
    volumes:
      - .:/app
      - ./data/zeek_logs:/app/data/zeek_logs
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://acra_admin:changeme123@postgres:5432/acra
      - REDIS_URL=redis://acra-redis:6379/0
      - PYTHONUNBUFFERED=1
    restart: always
{% extends "layouts/base.html" %}

{% block title %}Audit Système - ACRA SOC{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-light">
            <i class="fas fa-shield-alt text-cyan mr-2"></i>Journal d'Audit & Visibilité
        </h1>
        <div class="d-flex align-items-center gap-3">
            <a href="{{ url_for('auth.export_audit_logs') }}" class="btn btn-outline-warning btn-sm">
                <i class="fas fa-download mr-1"></i> Export Forensique (CSV)
            </a>
            <div class="text-muted small border-left pl-3 ml-3">
                <i class="fas fa-sync-alt fa-spin mr-1"></i> Mode : Temps Réel
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <span class="text-secondary small text-uppercase font-weight-bold mr-3">Filtrage rapide :</span>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-info filter-btn active" onclick="filterLogs('all', this)">Tous</button>
                        <button class="btn btn-sm btn-outline-danger filter-btn" onclick="filterLogs('fail', this)">Alertes & Échecs</button>
                        <button class="btn btn-sm btn-outline-success filter-btn" onclick="filterLogs('auth', this)">Authentification</button>
                        <button class="btn btn-sm btn-outline-warning filter-btn" onclick="filterLogs('admin', this)">Actions Admin</button>
                    </div>
                </div>
                <div class="col-md-6 mt-2 mt-md-0">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-transparent border-secondary text-secondary">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                        <input type="text" id="logSearch" class="form-control bg-dark border-secondary text-light" 
                               placeholder="Rechercher IP, Utilisateur, Action ou Erreur..." onkeyup="searchTable()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary shadow">
        <div class="card-header bg-dark-2 border-secondary d-flex justify-content-between align-items-center">
            <span class="font-weight-bold"><i class="fas fa-stream mr-2"></i>Flux des Événements</span>
            <span class="badge badge-secondary">{{ logs|length }} événements enregistrés</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0" id="auditTable">
                    <thead>
                        <tr class="text-secondary small text-uppercase bg-darker">
                            <th class="border-secondary py-3">Horodatage</th>
                            <th class="border-secondary">Acteur</th>
                            <th class="border-secondary">Type d'Action</th>
                            <th class="border-secondary">Statut</th>
                            <th class="border-secondary">Source IP / Agent</th>
                            <th class="border-secondary">Détails de l'Événement</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr class="log-row border-secondary 
                                   {% if not log.success %}row-fail bg-soft-danger{% endif %} 
                                   {% if 'AUTH' in log.action_type or 'LOGIN' in log.action_type %}row-auth{% endif %}
                                   {% if 'USER' in log.action_type or 'SYS' in log.action_type %}row-admin{% endif %}">
                            
                            <td class="text-nowrap">
                                <small class="text-info font-weight-bold">{{ log.performed_at.strftime('%H:%M:%S') }}</small><br>
                                <small class="text-muted">{{ log.performed_at.strftime('%d/%m/%Y') }}</small>
                            </td>

                            <td>
                                {% if log.user %}
                                    <span class="badge badge-outline-cyan font-weight-normal">
                                        <i class="fas fa-user-circle mr-1"></i>{{ log.user.username }}
                                    </span>
                                {% else %}
                                    <span class="text-secondary font-italic small"><i class="fas fa-robot mr-1"></i>SYSTEM</span>
                                {% endif %}
                            </td>

                            <td>
                                <span class="badge badge-dark border border-secondary text-warning">
                                    {{ log.action_type }}
                                </span>
                            </td>

                            <td>
                                {% if log.success %}
                                    <span class="text-success small font-weight-bold"><i class="fas fa-check-circle mr-1"></i>OK</span>
                                {% else %}
                                    <span class="text-danger small font-weight-bold" title="{{ log.error_message }}">
                                        <i class="fas fa-shield-virus mr-1"></i>CRITICAL
                                    </span>
                                {% endif %}
                            </td>

                            <td class="text-nowrap">
                                <code class="text-light small">{{ log.user_ip or 'Localhost' }}</code>
                                <i class="fas fa-info-circle text-muted ml-1" data-toggle="tooltip" title="{{ log.user_agent }}"></i>
                            </td>

                            <td>
                                <div class="text-light small detail-text">{{ log.action_details }}</div>
                                {% if log.error_message %}
                                <div class="text-danger x-small mt-1 font-italic">{{ log.error_message[:100] }}...</div>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-ghost fa-3x mb-3"></i><br>Silence radio. Aucun log détecté.
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



<style>
    /* Couleurs SOC ACRA */
    :root { --acra-cyan: #00bcd4; --dark-bg-2: #1a1d21; }
    .bg-dark-2 { background-color: var(--dark-bg-2); }
    .bg-darker { background-color: #0b0c0e; }
    .text-cyan { color: var(--acra-cyan); }
    
    /* Indicateurs de ligne */
    .row-fail { border-left: 4px solid #dc3545 !important; }
    .bg-soft-danger { background-color: rgba(220, 53, 69, 0.05); }
    .log-row:hover { background-color: rgba(255,255,255,0.05) !important; cursor: default; }

    /* Badges personnalisés */
    .badge-outline-cyan { border: 1px solid var(--acra-cyan); color: var(--acra-cyan); background: transparent; }
    .detail-text { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .detail-text:hover { white-space: normal; }
    .x-small { font-size: 0.75rem; }
</style>

{% endblock %}

{% block scripts %}
<script>
$(function () { $('[data-toggle="tooltip"]').tooltip() }); // Activation des bulles d'info

function filterLogs(criteria, btn) {
    const rows = document.querySelectorAll('.log-row');
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    rows.forEach(row => {
        let visible = false;
        if (criteria === 'all') visible = true;
        else if (criteria === 'fail') visible = row.classList.contains('row-fail');
        else if (criteria === 'auth') visible = row.classList.contains('row-auth');
        else if (criteria === 'admin') visible = row.classList.contains('row-admin');
        
        row.setAttribute('data-status-visible', visible);
        applyCombinedFilters(row);
    });
}

function searchTable() {
    const input = document.getElementById('logSearch').value.toUpperCase();
    const rows = document.querySelectorAll('.log-row');

    rows.forEach(row => {
        const text = row.textContent.toUpperCase();
        row.setAttribute('data-search-visible', text.includes(input));
        applyCombinedFilters(row);
    });
}

function applyCombinedFilters(row) {
    const statusVis = row.getAttribute('data-status-visible') !== 'false';
    const searchVis = row.getAttribute('data-search-visible') !== 'false';
    row.style.display = (statusVis && searchVis) ? '' : 'none';
}
</script>
{% endblock %}
{% extends "layouts/base.html" %}

{% block content %}
<style>
    /* Fix Layout Forced: Dimensions fixes et affichage immédiat */
    #cy { 
        width: 100%; 
        height: 750px; 
        background-color: #0b0c0e; 
        border-radius: 8px; 
        display: block;
        position: relative;
    }
    .bg-darker { background-color: #08090a; }
    .list-group-item { border-bottom: 1px dashed #333 !important; font-size: 0.85rem; padding: 10px 0; }
    .pulse-tiny {
        animation: pulse-blue 2s infinite;
        font-size: 0.65rem;
        padding: 5px 10px;
        border-radius: 4px;
    }
    @keyframes pulse-blue {
        0% { box-shadow: 0 0 0 0 rgba(0, 188, 212, 0.4); }
        70% { box-shadow: 0 0 0 6px rgba(0, 188, 212, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 188, 212, 0); }
    }
    #details-panel::-webkit-scrollbar { width: 5px; }
    #details-panel::-webkit-scrollbar-track { background: #0b0c0e; }
    #details-panel::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-9">
            <div class="card bg-dark text-white border-secondary shadow">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-project-diagram me-2 text-info"></i>Cartographie Réseau Temps Réel</h5>
                    <div class="d-flex align-items-center">
                        <div id="status-indicator" class="small text-success me-3">
                            <i class="fas fa-sync fa-spin me-1"></i> Live
                        </div>
                        <button class="btn btn-sm btn-outline-info" onclick="manualRefresh()" title="Forcer la mise à jour"> 
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0" style="height: 750px;">
                    <div id="cy"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary h-100 shadow">
                <div class="card-header border-secondary bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-microscope me-2"></i>Détails Asset</h5>
                </div>
                <div id="details-panel" class="card-body overflow-auto">
                    <div class="text-center mt-5">
                        <i class="fas fa-mouse-pointer fa-3x mb-3 text-secondary"></i>
                        <p class="text-muted small">Sélectionnez un appareil pour analyser son trafic et ses activités DNS.</p>
                    </div>
                </div>
                <div class="card-footer border-secondary bg-darker small text-center">
                    <span class="text-muted"><i class="fas fa-info-circle text-info me-1"></i> Rafraîchissement : Auto (15s)</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>

<script>
let cy = null;
const REFRESH_RATE = 30000;
let isFetching = false;

// URLs d'icônes stables
const ICON_MAP = {
    'router': 'https://img.icons8.com/color/96/router.png',
    'server': 'https://img.icons8.com/color/96/server.png',
    'computer': 'https://img.icons8.com/color/96/monitor--v1.png',
    'smartphone': 'https://img.icons8.com/color/96/iphone.png',
    'iot': 'https://img.icons8.com/color/96/processor.png',
    'external': 'https://img.icons8.com/color/96/earth-element.png'
};

async function loadData(isInitial = false) {
    if (isFetching) return; 
    isFetching = true;

    try {
        const res = await fetch("{{ url_for('network.get_topology_data') }}");
        
        // Gestion spécifique de l'erreur 429
        if (res.status === 429) {
            console.warn("Serveur saturé (429), pause du rafraîchissement...");
            updateStatus(false);
            setTimeout(() => { isFetching = false; loadData(); }, 30000); 
            return;
        }

        if (!res.ok) throw new Error("HTTP error " + res.status);
        const response = await res.json();

        if (response.status === "success") {
            if (isInitial || !cy) {
                initGraph(response.nodes, response.edges);
            } else {
                updateGraph(response.nodes, response.edges);
            }
            updateStatus(true);
        }
    } catch (err) {
        console.error("Erreur Topologie:", err);
        updateStatus(false);
    } finally {
        isFetching = false;
        // Programmation de la prochaine mise à jour SEULEMENT quand la précédente est terminée
        if (!isInitial) {
            setTimeout(() => loadData(false), REFRESH_RATE);
        }
    }
}

function updateStatus(isOnline) {
    const status = document.getElementById('status-indicator');
    if (!status) return;
    status.innerHTML = isOnline ? '<i class="fas fa-sync fa-spin me-1"></i> Live' : '<i class="fas fa-exclamation-triangle"></i> Erreur';
    status.className = isOnline ? 'small text-success me-3' : 'small text-danger me-3';
}

function initGraph(nodes, edges) {
    const filteredEdges = edges.filter(e => {
        const sourceNode = nodes.find(n => n.data.id === e.data.source);
        return sourceNode && sourceNode.data.status === 'online';
    });

    cy = cytoscape({
        container: document.getElementById('cy'),
        elements: { nodes: nodes, edges: filteredEdges },
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'color': '#bdc3c7',
                    'font-size': '10px',
                    'text-valign': 'bottom',
                    'text-margin-y': '8px',
                    'width': '45px',
                    'height': '45px',
                    'background-fit': 'contain',
                    'background-color': '#2c3e50',
                    'background-image': function(ele){ 
                        return ICON_MAP[ele.data('device_type')] || ICON_MAP['iot']; 
                    },
                    'text-background-opacity': 0.7,
                    'text-background-color': '#000',
                    'text-background-shape': 'roundrectangle',
                    'text-background-padding': '3px'
                }
            },
            { 
                selector: 'node[status = "offline"]', 
                style: { 
                    'opacity': 0.5, 
                    'background-color': '#3e1b1b',
                    'border-width': '1px',
                    'border-color': '#666'
                } 
            },
            { selector: 'node[device_type = "router"]', style: { 'width': '65px', 'height': '65px' } },
            { 
                selector: 'edge', 
                style: { 
                    'width': 2, 
                    'line-color': '#00bcd4', 
                    'curve-style': 'bezier', 
                    'opacity': 0.2,
                    'target-arrow-shape': 'triangle',
                    'target-arrow-color': '#00bcd4'
                } 
            },
            { selector: 'node:selected', style: { 'border-width': '3px', 'border-color': '#00bcd4' } }
        ],
        layout: { 
            name: 'cose', 
            animate: false,
            nodeRepulsion: 10000,
            padding: 50 
        }
    });

    cy.on('tap', 'node', (evt) => renderDetails(evt.target.data()));
}

function updateGraph(newNodes, newEdges) {
    if (!cy) return;
    const newNodeIds = newNodes.map(n => n.data.id);

    cy.nodes().forEach(node => {
        if (!newNodeIds.includes(node.id())) {
            node.remove();
        }
    });

    newNodes.forEach(n => {
        let node = cy.$id(n.data.id);
        if (node.length === 0) {
            cy.add(n);
        } else {
            node.data(n.data);
        }
    });

    cy.edges().remove();
    newEdges.forEach(e => {
        const sourceNodeData = newNodes.find(n => n.data.id === e.data.source);
        if (sourceNodeData && sourceNodeData.data.status === 'online') {
            cy.add(e);
        }
    });
}

function renderDetails(data) {
    const statusColor = data.status === 'online' ? 'success' : 'danger';
    let sitesHtml = '<p class="text-muted small mt-2">Aucun site détecté</p>';
    if (data.sites && data.sites.length > 0) {
        sitesHtml = data.sites.map(site => 
            `<span class="badge bg-dark border border-info text-info mb-1 me-1" style="font-size: 0.7rem; font-weight: normal;">${site}</span>`
        ).join('');
    }

    let html = `
        <div class="text-center mb-4">
            <h6 class="text-info mb-1"><b>${data.label.split('\n')[0]}</b></h6>
            <span class="badge bg-${statusColor} pulse-tiny">${data.status.toUpperCase()}</span>
        </div>
        
        <div class="list-group list-group-flush bg-transparent">
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">IP</small><code>${data.ip}</code>
            </div>
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">MAC</small><small class="text-muted" style="font-size:0.7rem">${data.mac}</small>
            </div>
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">Type</small><span class="badge bg-secondary text-capitalize">${data.device_type}</span>
            </div>
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">Trafic</small><span class="text-warning fw-bold">${data.usage}</span>
            </div>
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">Dernière vue</small><small>${data.last_seen}</small>
            </div>
        </div>

        <div class="mt-4">
            <label class="small text-uppercase text-muted fw-bold mb-2" style="letter-spacing: 1px;">Résolutions DNS</label>
            <div class="d-flex flex-wrap">
                ${sitesHtml}
            </div>
        </div>

        <button class="btn btn-sm btn-outline-info w-100 mt-4" onclick="alert('Analyse approfondie de ${data.ip}...')">
            <i class="fas fa-search me-1"></i> SCAN DE VULNÉRABILITÉ
        </button>
    `;
    document.getElementById('details-panel').innerHTML = html;
}

function manualRefresh() { loadData(false); }

// Utilisation de 'load' pour garantir que le conteneur est prêt
window.addEventListener('load', () => {
    loadData(true).then(() => {
        setTimeout(() => loadData(false), REFRESH_RATE);
    });
});
</script>
{% endblock %}
{% extends "layouts/base.html" %}

{% block content %}
<style>
    /* Style Cyber SOC */
    :root {
        --acra-cyan: #00bcd4;
        --acra-dark: #0a0c0e;
        --acra-darker: #050607;
        --acra-card: #1a1c1e;
        --acra-border: #2a2c2e;
        --acra-success: #2ecc71;
        --acra-warning: #f39c12;
        --acra-danger: #e74c3c;
        --acra-info: #3498db;
    }

    body {
        background-color: var(--acra-darker);
        font-family: 'Inter', 'Segoe UI', sans-serif;
    }

    /* Barre d'outils */
    .topology-toolbar {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        border-radius: 12px;
        padding: 16px 24px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .stats-group {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
    }

    .stat-label {
        color: #888;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-value {
        color: var(--acra-cyan);
        font-size: 1.8rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .stat-value span {
        color: #fff;
        font-size: 1rem;
        font-weight: normal;
        margin-left: 5px;
    }

    .filter-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filter-btn {
        background: var(--acra-dark);
        border: 1px solid var(--acra-border);
        color: #ccc;
        padding: 8px 16px;
        border-radius: 30px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-btn:hover {
        border-color: var(--acra-cyan);
        color: white;
    }

    .filter-btn.active {
        background: var(--acra-cyan);
        border-color: var(--acra-cyan);
        color: black;
        font-weight: 600;
    }

    .scan-btn {
        background: linear-gradient(135deg, var(--acra-cyan), #006688);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 0 15px rgba(0, 188, 212, 0.3);
    }

    .scan-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 25px rgba(0, 188, 212, 0.5);
    }

    /* Conteneur principal */
    .topology-container {
        display: flex;
        gap: 20px;
        height: calc(100vh - 250px);
        min-height: 700px;
    }

    /* Zone du graphe */
    .graph-container {
        flex: 1;
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    #cy {
        width: 100%;
        height: 100%;
        background-color: var(--acra-dark);
    }

    /* Overlay de chargement */
    .graph-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #888;
        font-size: 1.2rem;
        z-index: 10;
        background: rgba(0,0,0,0.7);
        padding: 15px 30px;
        border-radius: 50px;
        border: 1px solid var(--acra-border);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Panneau lat√©ral */
    .details-panel {
        width: 380px;
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .panel-header {
        padding: 20px;
        border-bottom: 1px solid var(--acra-border);
        background: var(--acra-darker);
    }

    .panel-header h3 {
        color: white;
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .panel-header h3 i {
        color: var(--acra-cyan);
    }

    .panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    /* √âtat vide */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state p {
        margin: 0;
        font-size: 0.95rem;
    }

    /* Carte d'information appareil */
    .device-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--acra-border);
    }

    .device-icon {
        width: 60px;
        height: 60px;
        background: var(--acra-dark);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        border: 2px solid var(--acra-cyan);
        overflow: hidden;
    }

    .device-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .device-title h4 {
        color: white;
        margin: 0 0 5px 0;
        font-size: 1.2rem;
    }

    .device-title .badge {
        background: var(--acra-cyan);
        color: black;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .info-card {
        background: var(--acra-darker);
        border-radius: 8px;
        padding: 12px;
        border: 1px solid var(--acra-border);
    }

    .info-card .label {
        color: #888;
        font-size: 0.7rem;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .info-card .value {
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .info-card .value small {
        color: #888;
        font-size: 0.7rem;
        font-weight: normal;
        margin-left: 5px;
    }

    /* Liste des ports */
    .ports-list {
        background: var(--acra-darker);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid var(--acra-border);
    }

    .ports-list h5 {
        color: white;
        margin: 0 0 10px 0;
        font-size: 0.9rem;
    }

    .port-badge {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        color: var(--acra-cyan);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        margin: 2px;
        display: inline-block;
    }

    /* Sites visit√©s */
    .sites-list {
        background: var(--acra-darker);
        border-radius: 8px;
        padding: 15px;
        border: 1px solid var(--acra-border);
    }

    .sites-list h5 {
        color: white;
        margin: 0 0 10px 0;
        font-size: 0.9rem;
    }

    .site-badge {
        background: var(--acra-card);
        border: 1px solid var(--acra-info);
        color: var(--acra-info);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        margin: 2px;
        display: inline-block;
    }

    /* Animation de pulsation */
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .live-badge {
        color: var(--acra-success);
        animation: pulse 2s infinite;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }
</style>

<div class="container-fluid px-4">
    <!-- Barre d'outils -->
    <div class="topology-toolbar">
        <div class="stats-group">
            <div class="stat-item">
                <span class="stat-label">Total</span>
                <span class="stat-value" id="stat-total">0<span>appareils</span></span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Internes</span>
                <span class="stat-value" id="stat-internal">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Externes</span>
                <span class="stat-value" id="stat-external">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Alertes</span>
                <span class="stat-value" id="stat-alerts" style="color: var(--acra-danger);">0</span>
            </div>
        </div>
        
        <div class="filter-group" id="filterGroup">
            <button class="filter-btn active" data-filter="all">
                <i class="fas fa-globe"></i> Tous
            </button>
            <button class="filter-btn" data-filter="internal">
                <i class="fas fa-home"></i> Internes
            </button>
            <button class="filter-btn" data-filter="external">
                <i class="fas fa-cloud"></i> Externes
            </button>
            <button class="filter-btn" data-filter="router">
                <i class="fas fa-wifi"></i> Routeurs
            </button>
            <button class="filter-btn" data-filter="server">
                <i class="fas fa-server"></i> Serveurs
            </button>
            <button class="filter-btn" data-filter="alert">
                <i class="fas fa-exclamation-triangle"></i> Alertes
            </button>
        </div>
        
        <button class="scan-btn" onclick="triggerScan()">
            <i class="fas fa-sync-alt"></i> Scan R√©seau
        </button>
    </div>

    <!-- Conteneur principal -->
    <div class="topology-container">
        <!-- Zone du graphe -->
        <div class="graph-container">
            <div class="graph-loading" id="graph-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Chargement...
            </div>
            <div id="cy"></div>
        </div>

        <!-- Panneau lat√©ral -->
        <div class="details-panel" id="details-panel">
            <div class="panel-header">
                <h3>
                    <i class="fas fa-microchip"></i>
                    D√©tails de l'√©quipement
                    <span class="live-badge ms-auto">
                        <i class="fas fa-circle"></i> LIVE
                    </span>
                </h3>
            </div>
            <div class="panel-content" id="panel-content">
                <div class="empty-state">
                    <i class="fas fa-mouse-pointer"></i>
                    <p>S√©lectionnez un appareil<br>pour voir ses d√©tails</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>

<script>
// Configuration
const CYAN = '#00bcd4';
const DANGER = '#e74c3c';
const SUCCESS = '#2ecc71';
const WARNING = '#f39c12';

let cy = null;
let socket = null;
let currentFilter = 'all';
let initialLayoutDone = false;

// Donn√©es initiales
const initialDevices = {{ devices|tojson }};
console.log('üìä Appareils initiaux:', initialDevices.length);

// Couleurs par type (pas d'images externes pour plus de rapidit√©)
const DEVICE_COLORS = {
    'router': '#ff9900',
    'server': '#00bcd4',
    'computer': '#2ecc71',
    'printer': '#9b59b6',
    'camera': '#e74c3c',
    'nas': '#3498db',
    'iot': '#f1c40f',
    'voip': '#1abc9c',
    'switch': '#95a5a6',
    'smartphone': '#e67e22',
    'external': '#7f8c8d',
    'unknown': '#95a5a6',
    'acra_system': '#ff3333'
};

// Initialisation WebSocket
function initWebSocket() {
    socket = io();
    
    socket.on('connect', () => {
        console.log('‚úÖ WebSocket connect√©');
        updateStatus(true);
        socket.emit('request_topology');
    });
    
    socket.on('scapy_topology', (data) => {
        console.log('üîÑ Topologie re√ßue:', data.nodes?.length, 'noeuds,', data.edges?.length, 'liaisons');
        if (data.nodes && data.nodes.length > 0) {
            if (!cy) {
                initGraph(data.nodes, data.edges || []);
            } else {
                updateGraph(data.nodes, data.edges || []);
            }
            updateStats(data.nodes);
        }
        document.getElementById('graph-loading').style.display = 'none';
    });
    
    socket.on('scapy_device', (device) => {
        console.log('‚ûï Nouvel appareil:', device.ip);
        if (device && device.ip) {
            addDeviceToGraph(device);
        }
    });
    
    socket.on('alert_update', (alert) => {
        console.log('‚ö†Ô∏è Alerte sur:', alert.ip);
        updateNodeAlert(alert.ip, alert.severity);
        updateStats();
    });
    
    socket.on('disconnect', () => {
        console.log('‚ùå WebSocket d√©connect√©');
        updateStatus(false);
    });
}

function updateStatus(isOnline) {
    // Optionnel: mettre √† jour un indicateur de statut
}

// Mettre √† jour les statistiques
function updateStats(nodes) {
    if (!cy) return;
    
    const visibleNodes = cy.nodes(':visible');
    let total = 0, internal = 0, external = 0, alerts = 0;
    
    visibleNodes.forEach(node => {
        const data = node.data();
        if (data.id === '0.0.0.0' || data.id === '255.255.255.255') return;
        total++;
        if (data.location === 'internal') internal++;
        else external++;
        alerts += data.alert_count || 0;
    });
    
    document.getElementById('stat-total').innerHTML = total + '<span>appareils</span>';
    document.getElementById('stat-internal').textContent = internal;
    document.getElementById('stat-external').textContent = external;
    document.getElementById('stat-alerts').textContent = alerts;
}

// Appliquer le filtre localement
function applyFilter(filter) {
    if (!cy) return;
    
    currentFilter = filter;
    console.log('üîç Filtre appliqu√©:', currentFilter);
    
    cy.nodes().forEach(node => {
        const deviceType = node.data('device_type');
        const location = node.data('location');
        const alertCount = node.data('alert_count') || 0;
        
        let visible = true;
        
        if (currentFilter === 'internal') {
            visible = (location === 'internal');
        } else if (currentFilter === 'external') {
            visible = (location === 'external');
        } else if (currentFilter === 'router') {
            visible = (deviceType === 'router');
        } else if (currentFilter === 'server') {
            visible = (deviceType === 'server');
        } else if (currentFilter === 'alert') {
            visible = (alertCount > 0);
        }
        
        if (visible) {
            node.show();
        } else {
            node.hide();
        }
    });
    
    updateStats();
}

// Initialiser le graphe
function initGraph(nodes, edges) {
    const formattedNodes = nodes.map(node => ({
        data: {
            id: node.id,
            label: node.id.split('.').slice(0,2).join('.') + '...',
            fullLabel: node.id,
            device_type: node.type || 'unknown',
            location: node.location || 'internal',
            status: 'online',
            mac: node.mac || 'N/A',
            manufacturer: node.manufacturer || 'inconnu',
            os: node.os || 'inconnu',
            total_bytes: node.total_bytes || 0,
            total_packets: node.packets || 0,
            open_ports: node.open_ports || [],
            sites: node.sites || [],
            alert_count: node.alert_count || 0,
            alert_severity: node.alert_severity || null,
            size: node.size || 50
        }
    }));

    const formattedEdges = (edges || []).map(edge => ({
        data: {
            id: edge.id || `${edge.from}-${edge.to}`,
            source: edge.from,
            target: edge.to,
            weight: edge.weight || 1,
            traffic: edge.traffic || 1000
        }
    }));

    cy = cytoscape({
        container: document.getElementById('cy'),
        elements: { nodes: formattedNodes, edges: formattedEdges },
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'color': '#fff',
                    'font-size': '10px',
                    'text-valign': 'bottom',
                    'text-margin-y': '25px',
                    'width': 50,
                    'height': 50,
                    'background-color': function(ele) {
                        return DEVICE_COLORS[ele.data('device_type')] || '#95a5a6';
                    },
                    'background-image': 'none',
                    'shape': 'ellipse',
                    'border-width': function(ele) {
                        return ele.data('alert_severity') ? 3 : 1;
                    },
                    'border-color': function(ele) {
                        if (ele.data('alert_severity') === 'P1') return DANGER;
                        if (ele.data('alert_severity') === 'P2') return WARNING;
                        return CYAN;
                    },
                    'border-opacity': 1
                }
            },
            {
                selector: 'node[device_type = "acra_system"]',
                style: {
                    'width': 100,
                    'height': 100,
                    'background-color': '#ff3333',
                    'border-width': 4,
                    'border-color': '#ffaa00',
                    'label': 'ACRA',
                    'font-size': '14px',
                    'font-weight': 'bold',
                    'text-background-color': '#ff3333',
                    'text-background-opacity': 1,
                    'text-background-padding': '5px',
                    'text-background-shape': 'roundrectangle',
                    'text-valign': 'bottom',
                    'text-margin-y': '60px',
                    'z-index': 1000
                }
            },
            {
                selector: 'node[device_type = "router"]',
                style: {
                    'width': 70,
                    'height': 70,
                    'border-width': 3,
                    'border-color': '#ff9900'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': function(ele) {
                        return Math.min(2 + (ele.data('traffic') / 10000), 5);
                    },
                    'line-color': function(ele) {
                        const source = ele.cy().getElementById(ele.data('source'));
                        if (source && source.data('device_type') === 'acra_system') {
                            return '#ff9900';
                        }
                        return CYAN;
                    },
                    'target-arrow-color': function(ele) {
                        const source = ele.cy().getElementById(ele.data('source'));
                        return source && source.data('device_type') === 'acra_system' ? '#ff9900' : CYAN;
                    },
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'opacity': 0.6,
                    'line-style': 'solid',
                    'line-cap': 'round',
                    'arrow-scale': 1.2
                }
            },
            {
                selector: 'edge[weight > 3]',
                style: {
                    'line-color': '#ff9900',
                    'target-arrow-color': '#ff9900',
                    'opacity': 0.9,
                    'width': 5
                }
            },
            {
                selector: 'node:selected',
                style: {
                    'border-width': 4,
                    'border-color': CYAN,
                    'background-opacity': 1
                }
            }
        ],
        layout: {
            name: 'circle',
            animate: false,
            radius: 300,
            startAngle: 0,
            fit: true,
            padding: 50
        }
    });

    // Apr√®s le layout initial, recentrer sur ACRA
    cy.ready(() => {
        const acraNode = cy.getElementById(initialDevices.find(d => d.type === 'acra_system')?.id || '');
        if (acraNode.length > 0) {
            cy.center(acraNode);
            cy.zoom(1.2);
        }
        
        applyFilter(currentFilter);
        initialLayoutDone = true;
    });

    // √âv√©nements
    cy.on('tap', 'node', (evt) => {
        const node = evt.target;
        showDeviceDetails(node.data());
    });

    cy.on('mouseover', 'node', (evt) => {
        const node = evt.target;
        node.style('border-width', 4);
    });

    cy.on('mouseout', 'node', (evt) => {
        const node = evt.target;
        const alert = node.data('alert_severity');
        node.style('border-width', alert ? 3 : 1);
    });

    updateStats(nodes);
    console.log('‚úÖ Graphe initialis√© avec', formattedNodes.length, 'noeuds et', formattedEdges.length, 'liaisons');
}

// Mettre √† jour le graphe
function updateGraph(newNodes, newEdges) {
    if (!cy) return;
    
    const newNodeIds = new Set(newNodes.map(n => n.id));
    
    cy.nodes().forEach(node => {
        if (!newNodeIds.has(node.id())) {
            node.remove();
        }
    });
    
    newNodes.forEach(nodeData => {
        const node = cy.$id(nodeData.id);
        if (node.length === 0) {
            cy.add({
                data: {
                    id: nodeData.id,
                    label: nodeData.id.split('.').slice(0,2).join('.') + '...',
                    fullLabel: nodeData.id,
                    device_type: nodeData.type || 'unknown',
                    location: nodeData.location || 'internal',
                    status: 'online',
                    mac: nodeData.mac || 'N/A',
                    manufacturer: nodeData.manufacturer || 'inconnu',
                    os: nodeData.os || 'inconnu',
                    total_bytes: nodeData.total_bytes || 0,
                    total_packets: nodeData.packets || 0,
                    open_ports: nodeData.open_ports || [],
                    sites: nodeData.sites || [],
                    alert_count: nodeData.alert_count || 0,
                    alert_severity: nodeData.alert_severity || null,
                    size: nodeData.size || 50
                }
            });
        }
    });
    
    applyFilter(currentFilter);
    updateStats();
}

// Ajouter un appareil au graphe
function addDeviceToGraph(device) {
    if (!cy) return;
    
    const node = cy.$id(device.ip);
    if (node.length === 0) {
        cy.add({
            data: {
                id: device.ip,
                label: device.ip.split('.').slice(0,2).join('.') + '...',
                fullLabel: device.ip,
                device_type: device.device_type || 'unknown',
                location: device.location || 'internal',
                status: 'online',
                mac: device.mac || 'N/A',
                manufacturer: device.manufacturer || 'inconnu',
                os: device.os || 'inconnu',
                total_bytes: device.total_bytes || 0,
                total_packets: device.total_packets || 0,
                open_ports: device.open_ports || [],
                sites: device.sites || [],
                alert_count: 0,
                size: 50
            }
        });
        
        applyFilter(currentFilter);
        updateStats();
        
        // Pas de re-layout pour √©viter le recalcul
    }
}

// Mettre √† jour l'alerte sur un noeud
function updateNodeAlert(ip, severity) {
    const node = cy.$id(ip);
    if (node.length > 0) {
        const count = (node.data('alert_count') || 0) + 1;
        node.data('alert_count', count);
        node.data('alert_severity', severity);
        
        node.style('border-width', 4);
        node.style('border-color', DANGER);
        setTimeout(() => {
            node.style('border-width', 3);
        }, 1000);
        
        updateStats();
    }
}

// Afficher les d√©tails d'un appareil
function showDeviceDetails(data) {
    const panel = document.getElementById('panel-content');
    
    const ports = data.open_ports || [];
    const portsHtml = ports.length > 0 
        ? ports.slice(0, 10).map(p => `<span class="port-badge">${p}</span>`).join('')
        : '<span class="text-muted">Aucun port d√©tect√©</span>';
    
    const sites = data.sites || [];
    const sitesHtml = sites.length > 0
        ? sites.slice(0, 10).map(s => `<span class="site-badge">${s}</span>`).join('')
        : '<span class="text-muted">Aucun site visit√©</span>';
    
    const trafficMB = Math.round((data.total_bytes || 0) / (1024 * 1024));
    
    panel.innerHTML = `
        <div class="device-header">
            <div class="device-icon" style="background-color: ${DEVICE_COLORS[data.device_type] || '#95a5a6'}">
                <i class="fas fa-network-wired" style="color: white; font-size: 30px;"></i>
            </div>
            <div class="device-title">
                <h4>${data.fullLabel || data.id}</h4>
                <span class="badge">${data.device_type}</span>
            </div>
        </div>
        
        <div class="info-grid">
            <div class="info-card">
                <div class="label">MAC</div>
                <div class="value">${data.mac || 'N/A'}</div>
            </div>
            <div class="info-card">
                <div class="label">Fabricant</div>
                <div class="value">${data.manufacturer || 'Inconnu'}</div>
            </div>
            <div class="info-card">
                <div class="label">OS</div>
                <div class="value">${data.os || 'N/A'}</div>
            </div>
            <div class="info-card">
                <div class="label">Trafic</div>
                <div class="value">${trafficMB}<small>MB</small></div>
            </div>
        </div>
        
        <div class="ports-list">
            <h5><i class="fas fa-plug" style="color: ${WARNING}"></i> Ports ouverts</h5>
            <div>
                ${portsHtml}
            </div>
        </div>
        
        <div class="sites-list">
            <h5><i class="fas fa-globe" style="color: ${SUCCESS}"></i> Sites visit√©s</h5>
            <div>
                ${sitesHtml}
            </div>
        </div>
    `;
}

// D√©clencher un scan
function triggerScan() {
    document.getElementById('graph-loading').style.display = 'flex';
    
    fetch('/api/network/control/scan', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error('Erreur r√©seau: ' + res.status);
        }
        return res.text();
    })
    .then(text => {
        console.log('R√©ponse brute:', text);
        setTimeout(() => {
            document.getElementById('graph-loading').style.display = 'none';
        }, 1000);
    })
    .catch(err => {
        console.error('Erreur scan:', err);
        document.getElementById('graph-loading').style.display = 'none';
        alert('Erreur lors du scan: ' + err.message);
    });
}

// Filtres
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    filterButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            filterButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            applyFilter(this.dataset.filter);
        });
    });
});

// Rafra√Æchissement manuel
function manualRefresh() {
    document.getElementById('graph-loading').style.display = 'flex';
    if (socket && socket.connected) {
        socket.emit('request_topology');
    } else {
        location.reload();
    }
}

// Initialisation
window.addEventListener('load', () => {
    console.log('üöÄ Initialisation de la topologie...');
    initWebSocket();
});
</script>
{% endblock %}
{% extends "layouts/base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-9">
            <div class="card bg-dark text-white border-secondary">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Cartographie Réseau Temps Réel</h5>
                    <div class="d-flex align-items-center">
                        <div id="status-indicator" class="small text-success me-3">
                            <i class="fas fa-sync fa-spin me-1"></i> Live
                        </div>
                        <button class="btn btn-sm btn-outline-info" onclick="manualRefresh()" title="Forcer la mise à jour"> 
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0" style="height: 750px; position: relative;">
                    <div id="cy" style="width: 100%; height: 100%; background-color: #0b0c0e;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary h-100 shadow">
                <div class="card-header border-secondary bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-microscope me-2"></i>Détails Asset</h5>
                </div>
                <div id="details-panel" class="card-body">
                    <div class="text-center mt-5">
                        <i class="fas fa-mouse-pointer fa-3x mb-3 text-secondary"></i>
                        <p class="text-muted small">Sélectionnez un appareil pour analyser ses propriétés en direct.</p>
                    </div>
                </div>
                <div class="card-footer border-secondary bg-darker small">
                    <i class="fas fa-info-circle text-info me-1"></i> Mise à jour auto : 5s
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>

<script>
let cy = null;
let updateInterval = null;
const REFRESH_RATE = 5000;

function loadData(isInitial = false) {
    fetch('/auth/api/v1/network/topology') 
        .then(res => res.json())
        .then(response => {
            if (isInitial || !cy) {
                initGraph(response.nodes, response.edges);
            } else {
                updateGraph(response.nodes, response.edges);
            }
            updateStatus(true);
        })
        .catch(err => {
            console.error("Erreur Topologie:", err);
            updateStatus(false);
        });
}

function updateStatus(isOnline) {
    const status = document.getElementById('status-indicator');
    if (isOnline) {
        status.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i> Live';
        status.className = 'small text-success me-3';
    } else {
        status.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Erreur Serveur';
        status.className = 'small text-danger me-3';
    }
}

function initGraph(nodes, edges) {
    cy = cytoscape({
        container: document.getElementById('cy'),
        elements: { nodes: nodes, edges: edges },
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'color': '#bdc3c7',
                    'font-size': '10px',
                    'text-valign': 'bottom',
                    'text-margin-y': '8px',
                    'width': '45px',
                    'height': '45px',
                    'background-fit': 'contain',
                    'background-color': 'rgba(0,0,0,0)',
                    'text-background-opacity': 0.7,
                    'text-background-color': '#000',
                    'text-background-shape': 'roundrectangle',
                    'text-background-padding': '3px'
                }
            },
            // États
            {
                selector: 'node[status = "offline"]',
                style: { 'opacity': 0.3, 'filter': 'grayscale(1)', 'color': '#ff4444' }
            },
            // Types d'icônes dynamiques
            {
                selector: 'node[device_type = "router"]',
                style: { 'background-image': 'https://img.icons8.com/fluency/96/router.png', 'width': '60px', 'height': '60px' }
            },
            {
                selector: 'node[device_type = "server"]',
                style: { 'background-image': 'https://img.icons8.com/fluency/96/server.png' }
            },
            {
                selector: 'node[device_type = "smartphone"]',
                style: { 'background-image': 'https://img.icons8.com/fluency/96/smartphone.png' }
            },
            {
                selector: 'node[device_type = "printer"]',
                style: { 'background-image': 'https://img.icons8.com/fluency/96/print.png' }
            },
            {
                selector: 'node[device_type = "computer"]',
                style: { 'background-image': 'https://img.icons8.com/fluency/96/laptop.png' }
            },
            {
                selector: 'node[device_type = "cloud"]',
                style: { 'background-image': 'https://img.icons8.com/fluency/96/cloud.png' }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#00bcd4',
                    'curve-style': 'bezier',
                    'opacity': 0.3,
                    'target-arrow-shape': 'none'
                }
            },
            {
                selector: 'node:selected',
                style: { 'border-width': '2px', 'border-color': '#ff9800', 'border-opacity': 1 }
            }
        ],
        layout: { name: 'cose', animate: true, nodeRepulsion: 10000, padding: 50 }
    });

    cy.on('tap', 'node', (evt) => renderDetails(evt.target.data(), evt.target.style('background-image')));
}

function updateGraph(newNodes, newEdges) {
    let changed = false;

    // Mise à jour des Noeuds
    newNodes.forEach(n => {
        let node = cy.$id(n.data.id);
        if (node.length === 0) {
            cy.add(n);
            changed = true;
        } else {
            node.data(n.data); // Update status/usage
        }
    });

    // Nettoyage et ajout des Edges
    let newEdgeIds = newEdges.map(e => e.data.id);
    cy.edges().forEach(e => {
        if (!newEdgeIds.includes(e.id())) { cy.remove(e); changed = true; }
    });
    newEdges.forEach(e => {
        if (cy.$id(e.data.id).length === 0) { cy.add(e); changed = true; }
    });

    // Ne relancer le layout que si de nouveaux éléments apparaissent
    if (changed) {
        // cy.layout({ name: 'cose', animate: true, fit: false }).run();
    }
}

function renderDetails(data, iconUrl) {
    const cleanIcon = iconUrl.replace(/url\(['"]?([^'"]*)['"]?\)/, '$1');
    document.getElementById('details-panel').innerHTML = `
        <div class="text-center mb-4">
            <img src="${cleanIcon}" width="64" class="mb-2">
            <h6 class="text-info mb-0"><b>${data.label}</b></h6>
            <small class="text-${data.status === 'online' ? 'success' : 'danger'} text-uppercase">${data.status}</small>
        </div>
        <div class="list-group list-group-flush bg-transparent">
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">IP</small>
                <code class="text-cyan">${data.ip}</code>
            </div>
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">TYPE</small>
                <span class="badge bg-outline-info text-uppercase">${data.device_type}</span>
            </div>
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">TRAFIC</small>
                <span class="text-warning">${data.usage || '0 Mo'}</span>
            </div>
            <div class="list-group-item bg-transparent text-white border-secondary px-0 d-flex justify-content-between">
                <small class="text-muted">VU LE</small>
                <small>${data.last_seen}</small>
            </div>
        </div>
        <div class="mt-4 text-center">
            <button class="btn btn-sm btn-outline-danger w-100 py-1" onclick="alert('Scan de vulnérabilités lancé sur ${data.ip}')">
                <i class="fas fa-shield-alt me-1"></i> SCAN VULN
            </button>
        </div>
    `;
}

function manualRefresh() { loadData(false); }

document.addEventListener('DOMContentLoaded', () => {
    loadData(true);
    setInterval(() => loadData(false), REFRESH_RATE);
});
</script>

<style>
    #cy { transition: opacity 0.3s ease; }
    .bg-darker { background-color: #08090a; }
    .text-cyan { color: #00e5ff; }
    .list-group-item { border-bottom: 1px dashed #333 !important; font-size: 0.85rem; }
    .badge-outline-info { border: 1px solid #00bcd4; color: #00bcd4; }
</style>
{% endblock %}
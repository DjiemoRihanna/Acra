{% extends "layouts/base.html" %}

{% block title %}Centre d'Alertes - ACRA SOC{% endblock %}

{% block content %}
<style>
    /* Style Cyber SOC pour les alertes */
    :root {
        --acra-cyan: #00bcd4;
        --acra-dark: #0a0c0e;
        --acra-darker: #050607;
        --acra-card: #1a1c1e;
        --acra-border: #2a2c2e;
        --acra-success: #2ecc71;
        --acra-warning: #f39c12;
        --acra-danger: #e74c3c;
        --acra-info: #3498db;
        --acra-purple: #9b59b6;
    }

    body {
        background-color: var(--acra-darker);
        font-family: 'Inter', 'Segoe UI', sans-serif;
    }

    /* Barre d'outils */
    .alerts-toolbar {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        border-radius: 12px;
        padding: 16px 24px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .stat-card .title {
        color: #888;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
    }

    .stat-card .value {
        color: var(--acra-cyan);
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .stat-card .subtitle {
        color: #666;
        font-size: 0.75rem;
        margin-top: 5px;
    }

    .severity-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .severity-P1 { background: var(--acra-danger); color: white; }
    .severity-P2 { background: var(--acra-warning); color: black; }
    .severity-P3 { background: var(--acra-info); color: white; }
    .severity-P4 { background: var(--acra-success); color: black; }
    .severity-P5 { background: #7f8c8d; color: white; }

    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .status-new { background: var(--acra-danger); color: white; }
    .status-in_progress { background: var(--acra-warning); color: black; }
    .status-resolved { background: var(--acra-success); color: black; }
    .status-false_positive { background: #7f8c8d; color: white; }
    .status-ignored { background: #34495e; color: white; }

    /* Tableau des alertes */
    .alerts-table {
        width: 100%;
        border-collapse: collapse;
    }

    .alerts-table th {
        text-align: left;
        padding: 15px 10px;
        color: #888;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--acra-border);
    }

    .alerts-table td {
        padding: 15px 10px;
        border-bottom: 1px solid var(--acra-border);
        color: #ccc;
        font-size: 0.9rem;
    }

    .alerts-table tbody tr {
        transition: all 0.2s;
        cursor: pointer;
    }

    .alerts-table tbody tr:hover {
        background: rgba(0, 188, 212, 0.1);
    }

    .alerts-table tbody tr.selected {
        background: rgba(0, 188, 212, 0.2);
        border-left: 3px solid var(--acra-cyan);
    }

    /* Filtres */
    .filter-section {
        background: var(--acra-darker);
        border: 1px solid var(--acra-border);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .filter-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-input {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        min-width: 200px;
    }

    .filter-input:focus {
        outline: none;
        border-color: var(--acra-cyan);
    }

    .filter-select {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        min-width: 150px;
    }

    .btn-filter {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-filter:hover {
        border-color: var(--acra-cyan);
        color: var(--acra-cyan);
    }

    .btn-filter.active {
        background: var(--acra-cyan);
        border-color: var(--acra-cyan);
        color: black;
    }

    /* Pagination */
    .pagination {
        display: flex;
        gap: 5px;
        justify-content: center;
        margin-top: 20px;
    }

    .page-item {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .page-item:hover {
        border-color: var(--acra-cyan);
    }

    .page-item.active {
        background: var(--acra-cyan);
        border-color: var(--acra-cyan);
        color: black;
    }

    .page-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Modal */
    .modal-content {
        background: var(--acra-card);
        border: 1px solid var(--acra-border);
        color: white;
    }

    .modal-header {
        border-bottom: 1px solid var(--acra-border);
    }

    .modal-footer {
        border-top: 1px solid var(--acra-border);
    }

    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    /* Timeline */
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline-item {
        position: relative;
        padding-left: 30px;
        margin-bottom: 20px;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--acra-cyan);
    }

    .timeline-item::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 12px;
        width: 2px;
        height: calc(100% - 5px);
        background: var(--acra-border);
    }

    .timeline-item:last-child::after {
        display: none;
    }

    .timeline-time {
        color: #888;
        font-size: 0.75rem;
        margin-bottom: 5px;
    }

    .timeline-title {
        color: white;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .timeline-description {
        color: #aaa;
        font-size: 0.85rem;
    }
</style>

<div class="container-fluid px-4">
    <!-- Barre d'outils -->
    <div class="alerts-toolbar">
        <div>
            <h4 class="text-white mb-0">
                <i class="fas fa-exclamation-triangle text-info me-2"></i>
                Centre d'Alertes
            </h4>
            <small class="text-muted">UC15 - Investigation d'incident</small>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-info" onclick="refreshAlerts()">
                <i class="fas fa-sync-alt"></i> Rafra√Æchir
            </button>
            <button class="btn btn-sm btn-outline-warning" onclick="exportAlerts()">
                <i class="fas fa-download"></i> Exporter
            </button>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="title">Total Alertes</div>
            <div class="value" id="stat-total">0</div>
            <div class="subtitle">toutes s√©v√©rit√©s</div>
        </div>
        <div class="stat-card">
            <div class="title">Critiques (P1)</div>
            <div class="value" style="color: var(--acra-danger);" id="stat-p1">0</div>
            <div class="subtitle">action imm√©diate requise</div>
        </div>
        <div class="stat-card">
            <div class="title">En cours</div>
            <div class="value" style="color: var(--acra-warning);" id="stat-in-progress">0</div>
            <div class="subtitle">investigation en cours</div>
        </div>
        <div class="stat-card">
            <div class="title">Taux de FP</div>
            <div class="value" id="stat-fp-rate">0%</div>
            <div class="subtitle">faux positifs</div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filter-section">
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" class="filter-input w-100" id="search-input" 
                       placeholder="üîç Rechercher IP, description...">
            </div>
            <div class="col-md-2">
                <select class="filter-select w-100" id="severity-filter">
                    <option value="">Toutes s√©v√©rit√©s</option>
                    <option value="P1">P1 - Critique</option>
                    <option value="P2">P2 - Haute</option>
                    <option value="P3">P3 - Moyenne</option>
                    <option value="P4">P4 - Basse</option>
                    <option value="P5">P5 - Info</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="filter-select w-100" id="status-filter">
                    <option value="">Tous statuts</option>
                    <option value="NEW">Nouveau</option>
                    <option value="IN_PROGRESS">En cours</option>
                    <option value="RESOLVED">R√©solu</option>
                    <option value="FALSE_POSITIVE">Faux positif</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="filter-select w-100" id="category-filter">
                    <option value="">Toutes cat√©gories</option>
                    <option value="MALWARE">Malware</option>
                    <option value="PHISHING">Phishing</option>
                    <option value="SCAN">Scan</option>
                    <option value="BRUTE_FORCE">Brute Force</option>
                    <option value="DATA_EXFIL">Exfiltration</option>
                    <option value="C2">C2</option>
                    <option value="ANOMALY">Anomalie</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <button class="btn-filter" onclick="applyFilters()">Appliquer</button>
                    <button class="btn-filter" onclick="resetFilters()">R√©initialiser</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des alertes -->
    <div class="card bg-dark text-white border-secondary shadow">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="alerts-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                            </th>
                            <th>S√©v√©rit√©</th>
                            <th>Date</th>
                            <th>Source</th>
                            <th>Destination</th>
                            <th>Cat√©gorie</th>
                            <th>Score</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-table-body">
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                    <p>Chargement des alertes...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>
</div>

<!-- Modal D√©tails Alerte -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-info me-2"></i>
                    D√©tails de l'alerte
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alert-details-content">
                <!-- Rempli par JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-info" onclick="startInvestigation()">D√©marrer investigation</button>
            </div>
        </div>
    </div>
</div>

<script>
// Configuration
let currentPage = 1;
let pageSize = 25;
let totalAlerts = 0;
let selectedAlerts = new Set();
let currentFilters = {};

// Chargement initial
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadAlerts();
    
    // Event listeners
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') applyFilters();
    });
});

// Charger les statistiques
function loadStats() {
    fetch('/api/alerts/stats')
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('stat-total').textContent = data.stats.total;
                document.getElementById('stat-p1').textContent = data.stats.by_severity?.P1 || 0;
                document.getElementById('stat-in-progress').textContent = data.stats.in_progress;
                
                // Calcul taux de FP
                const fp = data.stats.by_status?.FALSE_POSITIVE || 0;
                const total = data.stats.total || 1;
                document.getElementById('stat-fp-rate').textContent = 
                    Math.round((fp / total) * 100) + '%';
            }
        })
        .catch(err => console.error('Erreur stats:', err));
}

// Charger les alertes
function loadAlerts() {
    const params = new URLSearchParams({
        limit: pageSize,
        offset: (currentPage - 1) * pageSize,
        ...currentFilters
    });
    
    fetch(`/api/alerts?${params}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                totalAlerts = data.total;
                renderAlerts(data.alerts);
                renderPagination();
            }
        })
        .catch(err => console.error('Erreur chargement:', err));
}

// Afficher les alertes
function renderAlerts(alerts) {
    const tbody = document.getElementById('alerts-table-body');
    
    if (alerts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-check-circle fa-2x mb-3" style="color: var(--acra-success);"></i>
                        <p>Aucune alerte trouv√©e</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = alerts.map(alert => `
        <tr onclick="selectAlert(${alert.id})" class="${selectedAlerts.has(alert.id) ? 'selected' : ''}">
            <td onclick="event.stopPropagation()">
                <input type="checkbox" 
                       ${selectedAlerts.has(alert.id) ? 'checked' : ''} 
                       onchange="toggleAlert(${alert.id})">
            </td>
            <td>
                <span class="severity-badge severity-${alert.severity}">
                    ${alert.severity}
                </span>
            </td>
            <td>${new Date(alert.detected_at).toLocaleString()}</td>
            <td>${alert.source_ip}</td>
            <td>${alert.destination_ip}</td>
            <td>${alert.category}</td>
            <td>
                <div class="progress" style="height: 20px; width: 80px;">
                    <div class="progress-bar bg-${getScoreColor(alert.risk_score)}" 
                         style="width: ${alert.risk_score}%">
                        ${alert.risk_score}
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge status-${alert.status}">
                    ${formatStatus(alert.status)}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-info" 
                        onclick="event.stopPropagation(); viewAlert(${alert.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" 
                        onclick="event.stopPropagation(); updateStatus(${alert.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Fonctions utilitaires
function getScoreColor(score) {
    if (score >= 80) return 'danger';
    if (score >= 50) return 'warning';
    if (score >= 25) return 'info';
    return 'success';
}

function formatStatus(status) {
    const map = {
        'NEW': 'Nouveau',
        'IN_PROGRESS': 'En cours',
        'RESOLVED': 'R√©solu',
        'FALSE_POSITIVE': 'Faux positif',
        'IGNORED': 'Ignor√©'
    };
    return map[status] || status;
}

// Pagination
function renderPagination() {
    const totalPages = Math.ceil(totalAlerts / pageSize);
    let html = '';
    
    html += `<button class="page-item ${currentPage === 1 ? 'disabled' : ''}" 
                    onclick="changePage(${currentPage - 1})">¬´</button>`;
    
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="page-item ${i === currentPage ? 'active' : ''}" 
                            onclick="changePage(${i})">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += `<span class="page-item disabled">...</span>`;
        }
    }
    
    html += `<button class="page-item ${currentPage === totalPages ? 'disabled' : ''}" 
                    onclick="changePage(${currentPage + 1})">¬ª</button>`;
    
    document.getElementById('pagination').innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    loadAlerts();
}

// Filtres
function applyFilters() {
    currentFilters = {
        search: document.getElementById('search-input').value,
        severity: document.getElementById('severity-filter').value,
        status: document.getElementById('status-filter').value,
        category: document.getElementById('category-filter').value
    };
    currentPage = 1;
    loadAlerts();
}

function resetFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('severity-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('category-filter').value = '';
    currentFilters = {};
    currentPage = 1;
    loadAlerts();
}

// S√©lection multiple
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all').checked;
    const checkboxes = document.querySelectorAll('#alerts-table-body input[type="checkbox"]');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll;
        const id = parseInt(cb.closest('tr').getAttribute('onclick').match(/\d+/)[0]);
        if (selectAll) {
            selectedAlerts.add(id);
        } else {
            selectedAlerts.delete(id);
        }
    });
}

function toggleAlert(id) {
    if (selectedAlerts.has(id)) {
        selectedAlerts.delete(id);
    } else {
        selectedAlerts.add(id);
    }
}

function selectAlert(id) {
    // Pour la s√©lection simple
}

// Actions sur les alertes
function viewAlert(id) {
    fetch(`/api/alerts/${id}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                showAlertDetails(data.alert);
                new bootstrap.Modal(document.getElementById('alertModal')).show();
            }
        });
}

function showAlertDetails(alert) {
    const content = document.getElementById('alert-details-content');
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-info">Informations g√©n√©rales</h6>
                <table class="table table-dark table-borderless">
                    <tr>
                        <td class="text-muted">ID:</td>
                        <td>${alert.uuid}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">D√©tect√© le:</td>
                        <td>${new Date(alert.detected_at).toLocaleString()}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Source:</td>
                        <td>${alert.source_ip}:${alert.source_port || '?'}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Destination:</td>
                        <td>${alert.destination_ip}:${alert.destination_port || '?'}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Protocole:</td>
                        <td>${alert.protocol || 'N/A'}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-info">Scores</h6>
                <table class="table table-dark table-borderless">
                    <tr>
                        <td class="text-muted">Score final:</td>
                        <td><span class="badge bg-${getScoreColor(alert.risk_score)}">${alert.risk_score}</span></td>
                    </tr>
                    <tr>
                        <td class="text-muted">ML:</td>
                        <td>${alert.scores?.ml || 0}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">UEBA:</td>
                        <td>${alert.scores?.ueba || 0}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">TI:</td>
                        <td>${alert.scores?.ti || 0}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Contexte:</td>
                        <td>${alert.scores?.context || 0}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <h6 class="text-info mt-3">Description</h6>
        <p class="text-white">${alert.description || 'Aucune description'}</p>
        
        <h6 class="text-info mt-3">Preuves</h6>
        <ul class="list-group list-group-flush bg-transparent">
            ${alert.evidence ? alert.evidence.map(e => `
                <li class="list-group-item bg-transparent text-white border-secondary">
                    <i class="fas fa-check-circle text-success me-2"></i>${e}
                </li>
            `).join('') : '<li class="text-muted">Aucune preuve</li>'}
        </ul>
        
        ${alert.related_alerts && alert.related_alerts.length > 0 ? `
            <h6 class="text-info mt-3">Alertes connexes</h6>
            <div class="list-group">
                ${alert.related_alerts.slice(0, 5).map(a => `
                    <div class="list-group-item bg-transparent text-white border-secondary">
                        <small>${new Date(a.detected_at).toLocaleString()}</small>
                        <br>
                        ${a.source_ip} ‚Üí ${a.destination_ip}
                        <span class="badge bg-${getScoreColor(a.risk_score)} ms-2">${a.risk_score}</span>
                    </div>
                `).join('')}
            </div>
        ` : ''}
    `;
}

function updateStatus(id) {
    const newStatus = prompt('Nouveau statut (NEW, IN_PROGRESS, RESOLVED, FALSE_POSITIVE):');
    if (!newStatus) return;
    
    fetch(`/api/alerts/${id}/status`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: newStatus})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            loadAlerts();
            loadStats();
        }
    });
}

function startInvestigation() {
    alert('Fonctionnalit√© √† impl√©menter');
}

function refreshAlerts() {
    loadAlerts();
    loadStats();
}

function exportAlerts() {
    const params = new URLSearchParams({
        ...currentFilters,
        limit: 10000
    });
    
    window.location.href = `/api/alerts/export?${params}`;
}
</script>
{% endblock %}
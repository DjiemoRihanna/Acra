{% extends "layouts/base.html" %}

{% block title %}Profil Analyste | ACRA{% endblock %}

{% block content %}
<div class="dashboard-content">
    <div style="margin-bottom: 2rem; display: flex; align-items: center; gap: 15px;">
        <div style="width: 60px; height: 60px; background: var(--acra-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--acra-navy); font-weight: bold; border: 3px solid rgba(0, 188, 212, 0.3);">
            {{ current_user.username[0] | upper }}
        </div>
        <div>
            <h2 style="color: var(--acra-cyan); margin: 0;">{{ current_user.username }}</h2>
            <p style="color: var(--text-muted); margin: 0;">Analyste SOC - {{ current_user.role.value | upper }}</p>
        </div>
    </div>

    <div style="display: flex; gap: 30px;">
        <div style="width: 250px; display: flex; flex-direction: column; gap: 5px;">
            <button class="tab-btn active" onclick="showTab('identite')"><i class="fas fa-user-circle"></i> Identité </button>
            <button class="tab-btn" onclick="showTab('securite')"><i class="fas fa-shield-alt"></i> Sécurité </button>
            <button class="tab-btn" onclick="showTab('notifications')"><i class="fas fa-bell"></i> Notifications </button>
            <button class="tab-btn" onclick="showTab('interface')"><i class="fas fa-paint-brush"></i> Interface </button>
        </div>

        <div style="flex: 1; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 30px; min-height: 400px;">
            
            <div id="identite" class="tab-content">
                <h3 style="color: var(--text-main); margin-top: 0;">Informations Personnelles</h3>
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="update_info">
                    <div class="form-group">
                        <label>Matricule / Username</label>
                        <input type="text" name="username" value="{{ current_user.username }}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Email de contact</label>
                        <input type="email" name="email" value="{{ current_user.email }}" class="form-control">
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 20px;">Sauvegarder</button>
                </form>
            </div>

            <div id="securite" class="tab-content" style="display: none;">
                <h3 style="color: var(--text-main); margin-top: 0;">Authentification Multi-Facteurs (2FA)</h3>
                <div style="background: rgba(46, 204, 113, 0.1); border: 1px solid #2ecc71; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="color: #2ecc71; font-weight: bold;">Statut : Sécurisé (MFA Active)</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Votre session actuelle est vérifiée par code à usage unique.</div>
                    </div>
                    <i class="fas fa-check-shield" style="color: #2ecc71; font-size: 1.5rem;"></i>
                </div>
                
                <h3 style="color: var(--text-main);">Changer le mot de passe</h3>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;">
                    Politique SOC : 12+ caractères, une majuscule, un chiffre et un caractère spécial.
                </p>

                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="change_password">
                    
                    <div class="form-group">
                        <label>Mot de passe actuel</label>
                        <input type="password" name="old_password" class="form-control" required placeholder="••••••••">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Nouveau mot de passe</label>
                            <input type="password" name="new_password" class="form-control" required placeholder="Nouveau">
                        </div>
                        <div class="form-group">
                            <label>Confirmer le mot de passe</label>
                            <input type="password" name="confirm_password" class="form-control" required placeholder="Confirmation">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary" style="margin-top: 10px;">
                        <i class="fas fa-sync-alt"></i> Mettre à jour le mot de passe
                    </button>
                </form>
            </div>

            <div id="notifications" class="tab-content" style="display: none;">
                <h3 style="color: var(--text-main); margin-top: 0;">Alerte & Fatigue</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Définissez quand ACRA doit vous interrompre.</p>
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="update_preferences">
                    <div class="form-group">
                        <label>Seuil de sévérité minimal pour Email</label>
                        <select name="notif_level" class="form-control">
                            <option value="P1" {% if current_user.notif_level == 'P1' %}selected{% endif %}>Critique (P1) uniquement</option>
                            <option value="P2" {% if current_user.notif_level == 'P2' %}selected{% endif %}>Majeur (P2) et supérieur</option>
                            <option value="P4" {% if current_user.notif_level == 'P4' %}selected{% endif %}>Toutes les alertes</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 20px;">Enregistrer le seuil</button>
                </form>
            </div>

            <div id="interface" class="tab-content" style="display: none;">
                <h3 style="color: var(--text-main); margin-top: 0;">Personnalisation de l'environnement</h3>
                <form id="themeForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="update_preferences">
                    <input type="hidden" name="theme" id="themeInput" value="{{ current_user.theme }}">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="theme-card {% if current_user.theme == 'dark' %}active{% endif %}" onclick="selectTheme('dark')">
                            <div style="height: 60px; background: #060e17; border-radius: 4px; margin-bottom: 10px; border: 1px solid var(--acra-cyan);"></div>
                            <span style="color: var(--text-main);">Mode Cyber (Sombre)</span>
                        </div>
                        <div class="theme-card {% if current_user.theme == 'light' %}active{% endif %}" onclick="selectTheme('light')">
                            <div style="height: 60px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px; border: 1px solid #ccc;"></div>
                            <span style="color: var(--text-main);">Mode Standard (Clair)</span>
                        </div>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<style>
    .tab-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 12px 20px; text-align: left; border-radius: 6px; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
    .tab-btn:hover { background: rgba(0, 188, 212, 0.05); color: var(--text-main); }
    .tab-btn.active { background: rgba(0, 188, 212, 0.1); color: var(--acra-cyan); border-color: var(--acra-cyan); }
    
    .theme-card { background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; border: 2px solid transparent; cursor: pointer; text-align: center; font-size: 0.8rem; transition: 0.3s; }
    .theme-card:hover { background: rgba(255,255,255,0.05); }
    .theme-card.active { border-color: var(--acra-cyan); background: rgba(0, 188, 212, 0.05); }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 0.85rem; }
    .form-control { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); padding: 10px; color: var(--text-main); border-radius: 6px; transition: 0.3s; }
    .form-control:focus { border-color: var(--acra-cyan); outline: none; }
</style>

<script>
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById(tabId).style.display = 'block';
    event.currentTarget.classList.add('active');
}

function selectTheme(theme) {
    document.getElementById('themeInput').value = theme;
    document.body.className = theme + '-mode';
    document.getElementById('themeForm').submit();
}
</script>
{% endblock %}